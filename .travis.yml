 matrix:
  include:
    # Test build for Linux platform
    - language: cpp
      os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-7
      env:
        - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
      cache:
        directories:
      git:
        depth: false
        quiet: true

      before_install:
        - eval "${MATRIX_EVAL}"

      install:
      
      script:
        - echo "building knx-linux"
        - cd examples/knx-linux
        - mkdir -p build
        - cd build
        - cmake ..
        - cmake --build .
        - cd ../..
        - echo "building knx-linux-coupler"
        - cd knx-linux-coupler
        - mkdir -p build
        - cd build
        - cmake ..
        - cmake --build .

    # Test build for CC13x0 platform
    - language: minimal
      dist: focal
      os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - cmake
      env:
        #- MATRIX_EVAL="CC=arm-none-eabi-gcc && CXX=arm-none-eabi-g++"
        - GCC_URL="https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2019q4/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2?revision=108bd959-44bd-4619-9c19-26187abf5225&la=en&hash=E788CE92E5DFD64B2A8C246BBA91A249CB8E2D2D"
      cache:
        directories:
      git:
        depth: false
        quiet: true

      before_install:
        #- eval "${MATRIX_EVAL}"

      install:
        - pushd .
        - cd ~ 
        - mkdir arm-gcc-toolchain
        - wget -O $HOME/arm-gcc-toolchain/gcc.tar.bz2 $GCC_URL
        - cd arm-gcc-toolchain
        - tar -jxf gcc.tar.bz2 --strip=1
        - popd
        - export PATH=$HOME/arm-gcc-toolchain/bin:$PATH      

      before_script:
        - arm-none-eabi-gcc --version

      script:
        - echo "building knx-cc1310"
        - cd examples/knx-cc1310
        - mkdir -p build
        - cd build
        - cmake -DCMAKE_BUILD_TYPE=Debug ..
        - cmake --build .

    # Test build for PlatformIO based projects
    - language: python
      python:
        - "3.8"
      cache:
        directories:
          - "~/.platformio"
      env:
        - PLATFORMIO_EXTRA_SCRIPTS=pre:/tmp/scripts/custom_hwids.py
      install:
        - pip install -U platformio
        - platformio update      
      script:
        # PRE scripts have to be copied manually as "platformio ci does not care about it"
        - mkdir -p /tmp/scripts
        - cp examples/knx-usb/custom_hwids.py /tmp/scripts

        # Enable verbose output of platformio
        #- platformio settings set force_verbose yes

        - echo "-------";echo "Compiling example knx-usb";echo "--------";
        - platformio ci --lib="." --project-conf=examples/knx-usb/platformio-ci.ini examples/knx-usb/src/main.cpp

        - echo "-------";echo "Compiling example knx-demo";echo "--------";
        - platformio ci --lib="." --project-conf=examples/knx-demo/platformio-ci.ini examples/knx-demo/knx-demo.ino

        - echo "-------";echo "Compiling example knx-demo-coupler";echo "--------";
        - platformio ci --lib="." --project-conf=examples/knx-demo-coupler/platformio-ci.ini examples/knx-demo-coupler/knx-demo-coupler.ino

notifications:
  email:
    on_success: change
    on_failure: change
